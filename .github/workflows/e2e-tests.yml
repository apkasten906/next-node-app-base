name: E2E Tests

on:
  pull_request:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  e2e-tests:
    name: E2E Tests (${{ matrix.browser }}, ${{ matrix.os }})
    timeout-minutes: 30
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        browser: [chromium, firefox, webkit]
        include:
          - os: windows-latest
            browser: chromium
          - os: macos-latest
            browser: webkit

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: 25.x
          pnpm-version: 8.15.0

      - name: Build workspace packages required by backend
        run: pnpm --filter @repo/types build

      - name: Generate Prisma Client
        run: pnpm -C apps/backend db:generate

      - name: Install Playwright browsers (Linux)
        run: pnpm exec playwright install --with-deps ${{ matrix.browser }}
        working-directory: apps/frontend
        if: runner.os == 'Linux'

      - name: Install Playwright browsers (non-Linux)
        run: pnpm exec playwright install ${{ matrix.browser }}
        working-directory: apps/frontend
        if: runner.os != 'Linux'

      - name: Run E2E tests
        run: pnpm --filter frontend test:e2e --project=${{ matrix.browser }}
        env:
          E2E_BASE_URL: http://localhost:3000
          E2E_BACKEND_URL: http://localhost:3001
          NEXT_PUBLIC_API_URL: http://localhost:3001
          E2E_SEED_TOKEN: e2e-${{ github.run_id }}-${{ github.run_attempt }}-${{ matrix.os }}-${{ matrix.browser }}
          CI: true

      - name: Upload test results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}-${{ matrix.os }}
          path: apps/frontend/playwright-report/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload test videos
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: failure()
        with:
          name: playwright-videos-${{ matrix.browser }}-${{ matrix.os }}
          path: apps/frontend/test-results/
          retention-days: 7
          if-no-files-found: warn

      - name: Upload trace files
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: failure()
        with:
          name: playwright-traces-${{ matrix.browser }}-${{ matrix.os }}
          path: apps/frontend/test-results/**/*.zip
          retention-days: 7
          if-no-files-found: warn

  test-summary:
    name: Test Summary
    needs: e2e-tests
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          path: artifacts

      - name: Create test summary
        run: |
          {
            echo "## E2E Test Results"
            echo ""
            echo "Browser test results:"
          } >> "$GITHUB_STEP_SUMMARY"
          ls -la artifacts/ || echo "No artifacts found"

      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const pr = context.payload.pull_request;
            core.info(`github.actor=${context.actor}`);
            core.info(`event=${context.eventName}`);

            if (!pr) {
              core.info('No pull_request payload found; skipping PR comment.');
              return;
            }

            core.info(`pr.number=${pr.number}`);
            core.info(`pr.head.repo.full_name=${pr.head?.repo?.full_name}`);
            core.info(`pr.head.repo.fork=${pr.head?.repo?.fork}`);

            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const comment = [
              '## üé≠ E2E Test Results',
              '',
              'E2E tests completed across multiple browsers.',
              '',
              `‚û°Ô∏è [Open this workflow run (Artifacts are at the bottom)](${runUrl})`,
              '',
              'Download the `playwright-report-*` artifacts for the HTML report (and `playwright-traces-*` / `playwright-videos-*` on failures).',
            ].join('\n');

            try {
              await github.rest.issues.createComment({
                issue_number: pr.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment,
              });
              core.info('Posted PR comment with E2E results.');
            } catch (error) {
              const status = error?.status;
              if (status === 403) {
                core.warning(`Unable to post PR comment (403): ${error.message}`);
                return;
              }
              throw error;
            }
